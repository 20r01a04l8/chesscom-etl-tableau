name: Chess.com Daily Fetch â†’ Google Sheets

on:
  schedule:
    # Runs daily at 02:00 UTC (adjust cron as needed)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      usernames:
        description: 'Comma-separated chess.com usernames (override secret CHESS_USERNAMES)'
        required: false
        default: ''

permissions:
  contents: write

concurrency:
  group: chess-fetch
  cancel-in-progress: true

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      # CLI input or repository secret
      CHESS_USERNAMES: ${{ github.event.inputs.usernames || secrets.CHESS_USERNAMES || '' }}
      SHEET_ID: ${{ secrets.SHEET_ID || '' }}
      SHEET_NAME_PREFIX: ${{ secrets.SHEET_NAME_PREFIX || '' }}
      MAKE_USER_AGENT: ${{ secrets.MAKE_USER_AGENT || 'ChessAnalytics/1.0 (+your-email@example.com)' }}
      CHESS_REQUEST_DELAY: ${{ secrets.CHESS_REQUEST_DELAY || '1.0' }}
      CHESS_MAX_RETRIES: ${{ secrets.CHESS_MAX_RETRIES || '3' }}
      STATE_FILE: ${{ secrets.STATE_FILE || 'state.json' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests gspread google-auth

      - name: Ensure STATE_FILE exists (initial)
        run: |
          if [ ! -f "${{ env.STATE_FILE }}" ]; then
            printf "{}" > "${{ env.STATE_FILE }}"
            git add "${{ env.STATE_FILE }}" || true
            git commit -m "chore(state): add initial ${STATE_FILE}" || true
            git push origin HEAD || true
          fi

      - name: Decode service account secret
        # writes decoded JSON to ./sa.json for the script
        run: |
          if [ -z "${{ env.GSPREAD_SERVICE_ACCOUNT_JSON_B64 }}" ]; then
            echo "GSPREAD_SERVICE_ACCOUNT_JSON_B64 is empty - ensure secret is set"
            exit 1
          fi
          echo "${{ env.GSPREAD_SERVICE_ACCOUNT_JSON_B64 }}" | base64 --decode > sa.json
        shell: bash

      - name: Run fetch_and_post.py (writes to Google Sheets)
        run: |
          if [ -n "${{ github.event.inputs.usernames }}" ]; then
            python fetch_and_post.py "${{ github.event.inputs.usernames }}"
          else
            python fetch_and_post.py ""
          fi
        env:
          # pass the path to the decoded SA JSON and sheet id to the script
          GSPREAD_SA_JSON_PATH: ./sa.json
          SHEET_ID: ${{ env.SHEET_ID }}
          SHEET_NAME_PREFIX: ${{ env.SHEET_NAME_PREFIX }}
          MAKE_USER_AGENT: ${{ env.MAKE_USER_AGENT }}
          CHESS_REQUEST_DELAY: ${{ env.CHESS_REQUEST_DELAY }}
          CHESS_MAX_RETRIES: ${{ env.CHESS_MAX_RETRIES }}
          STATE_FILE: ${{ env.STATE_FILE }}
          CHESS_USERNAMES: ${{ env.CHESS_USERNAMES }}

      - name: Commit and push updated state.json and outputs (if changed)
        run: |
          git config user.name "github-actions[bot]" || true
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com" || true
          git add "${{ env.STATE_FILE }}" outputs || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update state and outputs [ci skip]" || true
            git push origin HEAD
          fi
