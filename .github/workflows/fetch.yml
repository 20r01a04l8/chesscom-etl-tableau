# .github/workflows/chess-daily-fetch.yml
name: Chess.com Daily Fetch (no Make)

on:
  schedule:
    # Runs daily at 02:00 UTC (adjust cron as needed)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      usernames:
        description: 'Comma-separated chess.com usernames (overrides secret CHESS_USERNAMES)'
        required: false
        default: ''

permissions:
  contents: write

concurrency:
  group: chess-fetch
  cancel-in-progress: true

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      # Provide sensible defaults or override via repo Secrets
      CHESS_USERNAMES: ${{ github.event.inputs.usernames || secrets.CHESS_USERNAMES || '' }}
      MAKE_USER_AGENT: ${{ secrets.MAKE_USER_AGENT || 'ChessAnalytics/1.0 (+your-email@example.com)' }}
      CHESS_REQUEST_DELAY: ${{ secrets.CHESS_REQUEST_DELAY || '1.0' }}
      CHESS_MAX_RETRIES: ${{ secrets.CHESS_MAX_RETRIES || '3' }}
      STATE_FILE: ${{ secrets.STATE_FILE || 'state.json' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          else
            python -m pip install --upgrade pip
            pip install requests
          fi

      - name: Ensure STATE_FILE exists (initial)
        run: |
          if [ ! -f "${{ env.STATE_FILE }}" ]; then
            printf "{}" > "${{ env.STATE_FILE }}"
            git add "${{ env.STATE_FILE }}" || true
            git commit -m "chore(state): add initial ${STATE_FILE}" || true
            git push origin HEAD || true
          fi

      - name: Run fetch_and_save script
        run: |
          # prefer CLI arg if workflow_dispatch input provided, otherwise rely on CHESS_USERNAMES env var
          if [ -n "${{ github.event.inputs.usernames }}" ]; then
            python fetch_and_post.py "${{ github.event.inputs.usernames }}"
          else
            python fetch_and_post.py ""
          fi
        env:
          MAKE_USER_AGENT: ${{ env.MAKE_USER_AGENT }}
          CHESS_REQUEST_DELAY: ${{ env.CHESS_REQUEST_DELAY }}
          CHESS_MAX_RETRIES: ${{ env.CHESS_MAX_RETRIES }}
          STATE_FILE: ${{ env.STATE_FILE }}
          CHESS_USERNAMES: ${{ env.CHESS_USERNAMES }}

      - name: Commit and push updated state.json and outputs (if changed)
        run: |
          git config user.name "github-actions[bot]" || true
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com" || true
          # add state file and outputs directory if changed
          git add "${{ env.STATE_FILE }}" outputs || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update state and outputs [ci skip]" || true
            git push origin HEAD
          fi
